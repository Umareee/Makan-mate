<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu Customization — Makan Mate</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'makan-orange': '#FF5722',
            'makan-orange-hover': '#E64A19',
            'custom-topbar': '#474747',
            'custom-navbar': '#F9F9F7',
            'custom-logo-bg': '#F9F9F71F',
            'custom-text': '#2C2F24',
            'panel-blue': '#eef7fb',
            'panel-blue-border': '#e1eef4'
          },
          fontFamily: {
            'playfair': ['Playfair Display','serif'],
            'dm-sans': ['DM Sans','sans-serif']
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: "DM Sans", sans-serif; }
    
    /* Minimal custom CSS - mostly using Tailwind */
    .dotted-hr { 
      border-bottom: 2px dotted #f4a18b; 
      padding-bottom: 8px; 
      display: inline-block; 
    }
    .cat-topline { 
      height: 6px; 
      border-bottom: 1px solid #e1edf3; 
      margin-top: 6px; 
    }
    
    /* Custom styles for dynamic card behavior */
    .card-collapsed {
      transition: all 0.3s ease;
    }
    
    .image-container {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .image-container.hidden {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
    
    .image-container.visible {
      max-height: 200px;
      opacity: 1;
      margin: 1rem 0;
      padding: 0;
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-white font-dm-sans text-custom-text">

  <!-- Header -->
  <header class="bg-gray-800 text-white">
    <!-- Top bar with contact info -->
    <div class="bg-custom-topbar py-2 px-2">
      <div class="container mx-auto px-2 sm:px-4 text-xs sm:text-sm">
        <!-- Mobile Layout -->
        <div class="flex sm:hidden justify-between items-start py-1">
          <div class="flex items-center space-x-1">
            <i class="fas fa-phone"></i>
            <span>62642233 Ext 10-18</span>
          </div>
          <div class="flex flex-col items-end space-y-1">
            <div class="flex items-center space-x-1">
              <i class="fas fa-envelope"></i>
              <span>order@makanmate.com</span>
            </div>
            <div class="flex space-x-2">
              <a href="#" class="w-6 h-6 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
                <i class="fab fa-twitter text-xs"></i>
              </a>
              <a href="#" class="w-6 h-6 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
                <i class="fab fa-facebook text-xs"></i>
              </a>
              <a href="#" class="w-6 h-6 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
                <i class="fab fa-instagram text-xs"></i>
              </a>
              <a href="#" class="w-6 h-6 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
                <i class="fab fa-github text-xs"></i>
              </a>
            </div>
          </div>
        </div>
        <!-- Desktop Layout -->
        <div class="hidden sm:flex justify-between items-center">
          <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
              <i class="fas fa-phone"></i>
              <span>62642233 Ext 10-18</span>
            </div>
            <div class="flex items-center space-x-2">
              <i class="fas fa-envelope"></i>
              <span>order@makanmate.com</span>
            </div>
          </div>
          <div class="flex space-x-3">
            <a href="#" class="w-8 h-8 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
              <i class="fab fa-twitter"></i>
            </a>
            <a href="#" class="w-8 h-8 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
              <i class="fab fa-facebook"></i>
            </a>
            <a href="#" class="w-8 h-8 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
              <i class="fab fa-instagram"></i>
            </a>
            <a href="#" class="w-8 h-8 bg-custom-logo-bg rounded-full flex items-center justify-center hover:text-makan-orange transition-colors">
              <i class="fab fa-github"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main navigation -->
  <nav class="bg-custom-navbar text-custom-text py-4 px-2 shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-2 sm:px-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 bg-yellow-400 rounded-full flex items-center justify-center cursor-pointer" onclick="window.location.href='index.html'">
          <img src="/images/mate-logo.png" alt="Makan Mate Logo" class="w-10 h-10 rounded-full">
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-makan-orange font-playfair cursor-pointer" onclick="window.location.href='index.html'">Makan Mate</h1>
        </div>
      </div>
      <div class="hidden lg:flex items-center space-x-4 xl:space-x-8">
        <a href="index.html" class="text-custom-text hover:text-makan-orange transition-colors font-medium">Home</a>
        <a href="about.html" class="text-custom-text hover:text-makan-orange transition-colors font-medium">About</a>
        <a href="menu.html" class="text-custom-text hover:text-makan-orange transition-colors font-medium">Menu</a>
        <a href="#" class="text-custom-text hover:text-makan-orange transition-colors font-medium">Pages</a>
        <a href="contact.html" class=" text-custom-text hover:text-makan-orange transition-colors font-medium">Contact</a>
        <a href="order.html" class="bg-makan-orange border-2 border-makan-orange text-white px-6 py-2 rounded-full hover:bg-custom-navbar hover:text-black transition-colors font-medium">Order Now</a>
      </div>
      <div class="lg:hidden">
        <button class="text-custom-text hover:text-makan-orange">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <h2 class="text-2xl font-playfair font-bold mb-6">Customize Your Menu</h2>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- LEFT CONTENT -->
      <section class="lg:col-span-9 lg:order-2">
        <div id="customization-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Categories will be dynamically loaded from JSON -->
          <div class="flex items-center justify-center p-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mr-3"></i>
            Loading customization options...
          </div>
        </div>

        <div class="mt-6">
          <button id="next-bottom" class="bg-makan-orange text-white px-6 py-3 rounded-lg font-bold hover:bg-makan-orange-hover transition-colors"><i class="fas fa-shopping-cart mr-2"></i>ADD TO CART</button>
        </div>
      </section>

      <!-- LEFT SIDEBAR -->
      <aside class="lg:col-span-3 lg:order-1 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="text-xs text-makan-orange font-semibold mb-3">
          <span class="dotted-hr">ORDER DETAILS</span>
        </div>
        
        <!-- Delivery Date and Time -->
        <div class="mb-6">
          <h4 class="font-semibold text-custom-text mb-2">Delivery Date & Time</h4>
          <div class="space-y-2">
            <input type="date" id="delivery-date" class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-makan-orange">
            <input type="time" id="delivery-time" class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-makan-orange">
          </div>
        </div>
        
        <!-- Previous Selections
         <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-2">Previous Selections</h4>
          <div class="space-y-3" id="previous-selections-container">
          </div>
        </div> -->
        
        <!-- Number of Packs -->
        <div class="mb-6">
          <h4 class="font-semibold text-custom-text mb-2">Number of Packs</h4>
          <div class="flex gap-2 items-center">
            <button class="w-8 h-8 bg-makan-orange rounded text-white text-sm font-bold hover:bg-makan-orange-hover transition-colors" onclick="changePacks(-1)">▼</button>
            <input class="flex-1 text-center border border-gray-300 h-8 rounded text-sm focus:outline-none focus:ring-2 focus:ring-makan-orange" type="number" value="10" min="10" id="packs-input">
            <button class="w-8 h-8 bg-makan-orange rounded text-white text-sm font-bold hover:bg-makan-orange-hover transition-colors" onclick="changePacks(1)">▲</button>
          </div>
          <p class="text-xs text-gray-500 mt-1">Minimum: 10 packs</p>
        </div>
        
        <!-- Cart Summary -->
        <div class="border-t border-gray-300 pt-4">
          <h4 class="font-semibold text-custom-text mb-2">Your Selection</h4>
          <div id="cart-container">
            <div class="text-gray-500 text-sm text-center py-4">
              <i class="fas fa-shopping-cart text-xl mb-2"></i><br>
              No items selected yet.
            </div>
          </div>
          <div class="border-t border-gray-300 mt-4 pt-4" id="cart-total" style="display: none;">
            <div class="text-sm font-semibold">TOTAL: <span id="total-amount" class="text-lg">$0.00</span></div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-12 mt-8">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <!-- Company Info -->
        <div class="mx-0 sm:mx-4">
          <h4 class="text-lg font-bold text-white mb-6">Company</h4>
          <ul class="space-y-3">
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">About Us</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Our Team</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Careers</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Contact</a></li>
          </ul>
        </div>

        <!-- Services -->
        <div class="mx-0 sm:mx-4">
          <h4 class="text-lg font-bold text-white mb-6">Services</h4>
          <ul class="space-y-3">
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Catering</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Delivery</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Events</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Corporate</a></li>
          </ul>
        </div>

        <!-- Quick Links -->
        <div class="mx-0 sm:mx-4">
          <h4 class="text-lg font-bold text-white mb-6">Quick Links</h4>
          <ul class="space-y-3">
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Menu</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Order Now</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">Locations</a></li>
            <li><a href="#" class="text-gray-300 hover:text-makan-orange transition-colors">FAQs</a></li>
          </ul>
        </div>

        <!-- Follow Us On Instagram -->
        <div>
          <h4 class="text-lg font-bold text-white mb-6">Follow Us On Instagram</h4>
          <div class="grid grid-cols-2 gap-3">
            <div class="aspect-square rounded-lg overflow-hidden">
              <img src="/images/pexels-steve-3789885 1.png" alt="Instagram Food Post" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
            </div>
            <div class="aspect-square rounded-lg overflow-hidden">
              <img src="/images/eiliv-aceron-d5PbKQJ0Lu8-unsplash 1.png" alt="Instagram Food Post" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
            </div>
            <div class="aspect-square rounded-lg overflow-hidden">
              <img src="/images/pexels-ella-olsson-1640772 1.png" alt="Instagram Food Post" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
            </div>
            <div class="aspect-square rounded-lg overflow-hidden">
              <img src="/images/pexels-ash-376464 1.png" alt="Instagram Food Post" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
            </div>
          </div>
        </div>
      </div>

      <!-- Copyright -->
      <div class="border-t border-gray-700 mt-12 pt-8 text-center">
        <p class="text-gray-400">
          Copyright © 2025 Makan Mate. All Rights Reserved
        </p>
      </div>
    </div>
  </footer>

  <!-- Mobile menu (hidden by default) -->
  <div class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-50 hidden" id="mobile-menu">
    <div class="bg-white w-64 h-full p-6">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-xl font-bold text-makan-orange">Menu</h2>
        <button class="text-gray-600" id="close-menu">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <nav class="space-y-4">
        <a href="index.html" class="block text-custom-text hover:text-makan-orange transition-colors py-2 border-b">Home</a>
        <a href="about.html" class="block text-custom-text hover:text-makan-orange transition-colors py-2 border-b">About</a>
        <a href="menu.html" class="block text-custom-text hover:text-makan-orange transition-colors py-2 border-b">Menu</a>
        <a href="#" class="block text-custom-text hover:text-makan-orange transition-colors py-2 border-b">Pages</a>
        <a href="contact.html" class="block text-custom-text hover:text-makan-orange transition-colors py-2 border-b">Contact</a>
        <a href="order.html" class="block bg-makan-orange text-white px-4 py-2 rounded-full text-center mt-6">Order Now</a>
      </nav>
    </div>
  </div>

  <!-- JS -->
<script>
    // Global variables
    let menuData = {};
    let selectedMenuItem = null;
    let cart = [];
    let packs = 10;

    // Load customization data and initialize page
    async function loadCustomizationData() {
      try {
        selectedMenuItem = JSON.parse(localStorage.getItem('selectedMenuItem') || 'null');
        
        if (!selectedMenuItem || !selectedMenuItem.customizable) {
          // Redirect if no customizable item selected
          Swal.fire({ 
            icon: 'error', 
            title: 'No Customizable Item', 
            text: 'Please select a customizable menu item first.' 
          }).then(() => {
            window.location.href = 'menu.html';
          });
          return;
        }

        // Fetch customization data based on data_source from menu item
        const dataSource = selectedMenuItem.data_source || 'menu-customization-data.json';
        const response = await fetch(`/${dataSource}`);
        if (!response.ok) {
          throw new Error('Failed to load customization data');
        }
        
        const allCustomizationData = await response.json();
        const customizationData = allCustomizationData[selectedMenuItem.id];
        
        if (!customizationData) {
          throw new Error(`No customization data found for ${selectedMenuItem.id}`);
        }
        
        // Build menuData from customization categories
        menuData = {};
        customizationData.categories.forEach(category => {
          menuData[category.id] = {};
          category.options.forEach(option => {
            menuData[category.id][option.id] = {
              name: option.name,
              image: option.image,
              price: option.price
            };
          });
        });
        
        // Build the customization interface
        buildCustomizationInterface(customizationData);
        
      } catch (error) {
        console.error('Error loading customization data:', error);
        document.getElementById('customization-container').innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center p-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
            <p class="text-lg font-semibold mb-2">Error Loading Customization Options</p>
            <p class="text-sm text-gray-600 mb-4">Unable to load customization data for this menu item.</p>
            <button onclick="window.location.href='menu.html'" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">
              Back to Menu
            </button>
          </div>
        `;
      }
    }

    // Build the customization interface from loaded data
    function buildCustomizationInterface(data) {
      const container = document.getElementById('customization-container');
      container.innerHTML = '';
      
      data.categories.forEach(category => {
        const categoryCard = createCategoryCard(category);
        container.appendChild(categoryCard);
      });
    }

    // Create a category card
    function createCategoryCard(category) {
      const card = document.createElement('div');
      card.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 card-collapsed';
      
      // Calculate dynamic limits for this category
      let effectiveMaxSelections = category.max_selections;
      let categoryDescription = '';
      
      if (category.dynamic_selection && category.type === 'checkbox') {
        effectiveMaxSelections = Math.min(remainingCheckboxSelections, category.max_selections);
      } else if (category.type === 'radio') {
      }
      
      const titleSection = document.createElement('div');
      titleSection.innerHTML = `
        <div class="font-semibold text-gray-800 uppercase text-base mb-1">${category.name}${categoryDescription}</div>
        <div class="text-xs text-gray-600 mb-2" id="${category.id}-selection-info">
          ${category.dynamic_selection ? `Available selections: ${effectiveMaxSelections}` : ''}
        </div>
        <div class="cat-topline"></div>
      `;
      card.appendChild(titleSection);
      
      const optionsSection = document.createElement('div');
      optionsSection.className = 'mt-4 space-y-2';
      optionsSection.setAttribute('data-max-selections', effectiveMaxSelections);
      optionsSection.setAttribute('data-category-type', category.type);
      optionsSection.setAttribute('data-category-id', category.id);
      
      if (category.type === 'checkbox') {
        // Multiple selection (checkboxes)
        category.options.forEach(option => {
          const optionElement = createCheckboxOption(category.id, option);
          optionsSection.appendChild(optionElement);
        });
      } else {
        // Single selection (radio buttons) - default
        category.options.forEach(option => {
          const optionElement = createRadioOption(category.id, option);
          optionsSection.appendChild(optionElement);
        });
        
        // Add quantity controls for radio categories
        // const quantityControls = createQuantityControls(category.id);
        // optionsSection.appendChild(quantityControls);
      }
      
      card.appendChild(optionsSection);
      return card;
    }

    // Create checkbox option (for multiple selection categories)
    function createCheckboxOption(categoryId, option) {
      const label = document.createElement('label');
      label.className = 'flex items-center gap-2 cursor-pointer flex-wrap';
      
      label.innerHTML = `
        <input type="checkbox" name="${categoryId}" value="${option.id}" class="text-orange-500 focus:ring-orange-500 shrink-0" onchange="handleCheckboxChange(this, '${categoryId}')">
        <img src="${option.image}" alt="${option.name}" class="w-10 h-10 object-cover rounded shrink-0">
        <span class="text-sm flex-1 min-w-0">${option.name}</span>
        <!-- Per-item Quantity Controls (hidden until checked) -->
      `;
      
      return label;
    }

    // Create radio option (for single selection categories)
    function createRadioOption(categoryId, option) {
      const label = document.createElement('label');
      label.className = 'flex items-center gap-2 cursor-pointer';
      
      label.innerHTML = `
        <input type="radio" name="${categoryId}" value="${option.id}" class="text-orange-500 focus:ring-orange-500" onchange="handleSelection(this, '${categoryId}')">
        <img src="${option.image}" alt="${option.name}" class="w-10 h-10 object-cover rounded">
        <span class="text-sm">${option.name}</span>
      `;
      
      return label;
    }

    // Create quantity controls for radio categories
    // function createQuantityControls(categoryId) {
    //   const controls = document.createElement('div');
    //   controls.className = 'mt-4 hidden';
    //   controls.id = `${categoryId}-controls`;
      
    //   controls.innerHTML = `
    //     <div class="flex gap-2 items-center">
    //       <button class="w-8 h-8 bg-orange-500 rounded text-white text-sm font-bold hover:bg-orange-600 transition-colors qty-down" onclick="changeQuantity('${categoryId}', -1)">▼</button>
    //       <input class="flex-1 min-w-16 text-center border border-gray-300 h-8 rounded text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 qty-input" type="number" value="10" min="10" id="${categoryId}-qty" oninput="onQtyInput('${categoryId}')">
    //       <button class="w-8 h-8 bg-orange-500 rounded text-white text-sm font-bold hover:bg-orange-600 transition-colors qty-up" onclick="changeQuantity('${categoryId}', 1)">▲</button>
    //     </div>
    //   `;
      
    //   return controls;
    // }

    // Initialize page
    // Global variables for dynamic selection
    let totalSelectableItems = 0;
    let fixedRadioSelections = 3; // Sweet Delight, Beverage, Hot Serve
    let remainingCheckboxSelections = 0;
    let currentTotalSelected = 0;

    // Extract total items from quantity selection and update packs
    function extractTotalItemsFromQuantity() {
      try {
        const selectedWithQuantity = JSON.parse(localStorage.getItem('selectedItemWithQuantity') || 'null');
        if (selectedWithQuantity && selectedWithQuantity.quantityTitle) {
          // Extract number from titles like "High Tea Select 4 Items + Drinks @ $9.00 per pax"
          const match = selectedWithQuantity.quantityTitle.match(/select\s+(\d+)\s+items/i);
          if (match) {
            totalSelectableItems = parseInt(match[1]);
            remainingCheckboxSelections = totalSelectableItems - fixedRadioSelections;
            
            // Update global packs variable with minimum pax requirement
            if (selectedWithQuantity.minimumPax) {
              packs = selectedWithQuantity.minimumPax;
            }
            
            console.log(`Dynamic Selection: Total ${totalSelectableItems} items, ${remainingCheckboxSelections} checkbox selections available, Minimum pax: ${packs}`);
            return true;
          }
        }
      } catch (error) {
        console.error('Error extracting quantity info:', error);
      }
      
      // Fallback to default if extraction fails
      totalSelectableItems = 4; // Default
      remainingCheckboxSelections = 1; // 4 - 3 = 1
      packs = 10; // Default minimum
      console.log('Using fallback: 4 total items, 1 checkbox selection, 10 minimum pax');
      return false;
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('delivery-date').min = today;
      
      // Set default delivery time to current time + 1 hour
      const now = new Date();
      now.setHours(now.getHours() + 1);
      const timeString = now.toTimeString().slice(0, 5);
      document.getElementById('delivery-time').value = timeString;
      
      // Extract quantity selection info
      extractTotalItemsFromQuantity();
      
      // Update packs input and minimum display
      const packsInput = document.getElementById('packs-input');
      const packsMinText = document.querySelector('.text-xs.text-gray-500');
      if (packsInput) {
        packsInput.value = packs;
        packsInput.min = packs;
      }
      if (packsMinText) {
        packsMinText.textContent = `Minimum: ${packs} packs`;
      }

      // Load customization data and build interface
      loadCustomizationData();

      // Read selected items from previous selections
      try {
        const container = document.getElementById('previous-selections-container');
        if (container) {
          let cardsHtml = '';
          
          // First, add the main menu item (from menu.html)
          const selectedMenuItem = JSON.parse(localStorage.getItem('selectedMenuItem') || 'null');
          if (selectedMenuItem) {
            cardsHtml += `
            <div class="bg-white p-3 rounded border border-gray-200">
              <div class="flex items-center gap-3">
                <img src="${selectedMenuItem.image}" alt="${selectedMenuItem.name}" class="w-12 h-12 rounded object-cover">
                <div class="flex-1">
                  <div class="text-sm font-semibold text-gray-800">${selectedMenuItem.name}</div>
                </div>
                <div class="text-sm font-semibold">${Number(selectedMenuItem.price || 0).toFixed(2)}</div>
              </div>
            </div>`;
          }
          
          // Then, add the quantity selection item (from quantity-selection.html)
          const selectedWithQuantity = JSON.parse(localStorage.getItem('selectedItemWithQuantity') || 'null');
          if (selectedWithQuantity) {
            const quantityDisplay = selectedWithQuantity.quantityTitle || 
                                   `${selectedWithQuantity.quantity} ${selectedWithQuantity.quantity === '1' ? 'Pack' : 'Packs'}`;
            
            cardsHtml += `
            <div class="bg-white p-3 rounded border border-gray-200">
              <div class="flex items-center gap-3">
                <img src="${selectedWithQuantity.image}" alt="${selectedWithQuantity.name}" class="w-12 h-12 rounded object-cover">
                <div class="flex-1">
                  <div class="text-xs text-gray-500">${quantityDisplay}</div>
                </div>
                <div class="text-sm font-semibold">${selectedWithQuantity.totalPrice || Number(selectedWithQuantity.price || 0).toFixed(2)}</div>
              </div>
            </div>`;
          }
          
          // Set the combined HTML
          container.innerHTML = cardsHtml || `
            <div class="text-gray-500 text-sm text-center py-4">
              No previous selections found.
            </div>`;
        }
      } catch {}
      
      updateCartDisplay();
    });

    function initializeOptionImages() {
      const imgs = document.querySelectorAll('img[data-category][data-value]');
      imgs.forEach(img => {
        const category = img.getAttribute('data-category');
        const value = img.getAttribute('data-value');
        const data = menuData[category]?.[value];
        if (data && data.image) {
          img.src = data.image;
        }
      });
    }

    // Count current selections across all categories
    function countCurrentSelections() {
      let radioSelections = 0;
      let checkboxSelections = 0;
      
      // Count radio selections
      document.querySelectorAll('input[type="radio"]:checked').forEach(() => {
        radioSelections++;
      });
      
      // Count checkbox selections
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(() => {
        checkboxSelections++;
      });
      
      currentTotalSelected = radioSelections + checkboxSelections;
      return { radioSelections, checkboxSelections, total: currentTotalSelected };
    }

    // Update selection progress UI
    function updateSelectionProgress() {
      const counts = countCurrentSelections();
      const remaining = totalSelectableItems - counts.total;
      
      // Update progress indicator if it exists
      const progressElement = document.getElementById('selection-progress');
      if (progressElement) {
        progressElement.textContent = `Selected ${counts.total} of ${totalSelectableItems} items`;
        progressElement.className = remaining === 0 ? 'text-green-600 font-semibold' : 'text-gray-600';
      }
    }

    // Generic checkbox handler for any category
    function handleCheckboxChange(checkbox, category) {
      const key = checkbox.value;
      const optionsSection = checkbox.closest('[data-category-id]');
      const maxSelections = parseInt(optionsSection.getAttribute('data-max-selections'));
      
      if (checkbox.checked) {
        // Check if we're at the total limit
        const counts = countCurrentSelections();
        if (counts.total > totalSelectableItems) {
          checkbox.checked = false;
          Swal.fire({
            icon: 'warning',
            title: 'Selection Limit Reached',
            text: `You can only select ${totalSelectableItems} items total. Please deselect other items first.`,
            confirmButtonColor: '#FF5722'
          });
          return;
        }
        
        // Check category-specific limit
        const categoryChecked = optionsSection.querySelectorAll('input[type="checkbox"]:checked').length;
        if (categoryChecked > maxSelections) {
          checkbox.checked = false;
          const categoryName = category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
          Swal.fire({
            icon: 'info',
            title: 'Category Limit Reached',
            text: `You can only select ${maxSelections} item${maxSelections === 1 ? '' : 's'} from ${categoryName}.`,
            confirmButtonColor: '#FF5722'
          });
          return;
        }
        
        upsertCartItem(category, key, packs);
      } else {
        removeCartItem(category, key);
      }
      
      updateSelectionProgress();
    }

    // Main course checkbox handler (keeping for backward compatibility)
    function handleMainCourseCheck(checkbox) {
      handleCheckboxChange(checkbox, 'main-course');
    }

    // function changeItemQuantity(category, key, change) {
    //   const qtyInput = document.getElementById(`${category}-qty-${key}`);
    //   if (!qtyInput) return;
    //   const maxQty = packs + 5;
    //   let next = Number(qtyInput.value) + change;
    //   if (next < packs) next = packs;
    //   if (next > maxQty) {
    //     next = maxQty;
    //     Swal.fire({ icon: 'warning', title: 'Limit reached', text: `You can add up to ${maxQty} (minimum ${packs} + 5).` });
    //   }
    //   qtyInput.value = next;
    //   upsertCartItem(category, key, next);
    // }

    // function onItemQtyInput(category, key) {
    //   const qtyInput = document.getElementById(`${category}-qty-${key}`);
    //   if (!qtyInput) return;
    //   const maxQty = packs + 5;
    //   let val = Number(qtyInput.value);
    //   if (Number.isNaN(val)) val = packs;
    //   if (val < packs) val = packs;
    //   if (val > maxQty) {
    //     val = maxQty;
    //     Swal.fire({ icon: 'warning', title: 'Limit reached', text: `You can add up to ${maxQty} (minimum ${packs} + 5).` });
    //   }
    //   qtyInput.value = val;
    //   upsertCartItem(category, key, val);
    // }

    // Handle radio button selection (non-main-course categories)
    function handleSelection(radioButton, category) {
      const selectedValue = radioButton.value;
      const selectedItem = menuData[category][selectedValue];
      if (!selectedItem) return;
      // Show quantity controls for the category
      // const controls = document.getElementById(`${category}-controls`);
      // if (controls) controls.classList.remove('hidden');
      // Update quantity input to match packs
      // const qtyInput = document.getElementById(`${category}-qty`);
      // if (qtyInput) {
      //   qtyInput.value = packs;
      //   qtyInput.min = packs;
      // }
      // Auto add/update cart with default packs
      upsertCart(category);
      updateSelectionProgress();
    }

    // Change quantity with cap packs + 5
    function changeQuantity(category, change) {
      const qtyInput = document.getElementById(`${category}-qty`);
      const maxQty = packs + 5;
      let next = Number(qtyInput.value) + change;
      if (next < packs) next = packs;
      if (next > maxQty) {
        next = maxQty;
        Swal.fire({ icon: 'warning', title: 'Limit reached', text: `You can add up to ${maxQty} (minimum ${packs} + 5).` });
      }
      qtyInput.value = next;
      upsertCart(category);
    }

    // Quantity manual input handler with cap packs + 5
    function onQtyInput(category) {
      const qtyInput = document.getElementById(`${category}-qty`);
      const maxQty = packs + 5;
      let val = Number(qtyInput.value);
      if (Number.isNaN(val)) val = packs;
      if (val < packs) val = packs;
      if (val > maxQty) {
        val = maxQty;
        Swal.fire({ icon: 'warning', title: 'Limit reached', text: `You can add up to ${maxQty} (minimum ${packs} + 5).` });
      }
      qtyInput.value = val;
      upsertCart(category);
    }

    // Change packs
    function changePacks(change) {
      const packsInput = document.getElementById('packs-input');
      const minPacks = parseInt(packsInput.min) || packs; // Use the dynamic minimum
      const newPacks = Math.max(minPacks, Number(packsInput.value) + change);
      packsInput.value = newPacks;
      packs = newPacks;
      
      // Update category-level quantity inputs (radio categories only)
      const radioCategories = ['chicken', 'dessert', 'drinks'];
      radioCategories.forEach(category => {
        const qtyInput = document.getElementById(`${category}-qty`);
        if (qtyInput) {
          qtyInput.min = packs;
          if (Number(qtyInput.value) < packs) {
            qtyInput.value = packs;
          }
        }
        // If there is a selected item for this category, upsert with new min
        const radioSelected = document.querySelector(`input[name="${category}"]:checked`);
        if (radioSelected) {
          upsertCart(category);
        }
      });

      // Update per-item quantity inputs for main-course checkboxes
      const mainChecks = document.querySelectorAll('input[type="checkbox"][name="main-course"]:checked');
      mainChecks.forEach(cb => {
        const val = cb.value;
        const qtyInput = document.getElementById(`main-course-qty-${val}`);
        if (qtyInput) {
          qtyInput.min = packs;
          if (Number(qtyInput.value) < packs) {
            qtyInput.value = packs;
          }
          upsertCartItem('main-course', val, Number(qtyInput.value));
        }
      });

      // Ensure cart items respect new min
      cart = cart.map(item => ({
        ...item,
        quantity: Math.max(item.quantity, packs)
      }));
      updateCartDisplay();
    }

    // Upsert selected single item into cart for a category (radio categories)
    function upsertCart(category) {
      const qtyInput = document.getElementById(`${category}-qty`);
      const quantity = Math.max(packs, Number(qtyInput?.value || packs));
      const radioButton = document.querySelector(`input[name="${category}"]:checked`);
      if (!radioButton) return;
      const selectedValue = radioButton.value;
      const selectedItem = menuData[category][selectedValue];
      if (!selectedItem) return;
      const cartItem = {
        category,
        key: selectedValue,
        name: selectedItem.name,
        image: selectedItem.image
      };
      const existingIndex = cart.findIndex(item => item.category === category);
      if (existingIndex > -1) {
        cart[existingIndex] = cartItem;
      } else {
        cart.push(cartItem);
      }
      updateCartDisplay();
    }

    // Upsert a specific item (for checkbox categories like main-course)
    function upsertCartItem(category, key, quantity) {
      const item = menuData[category]?.[key];
      if (!item) return;
      const cartItem = {
        category,
        key,
        name: item.name,
        price: item.price,
        quantity: Math.max(packs, Number(quantity) || packs),
        image: item.image
      };
      const existingIndex = cart.findIndex(ci => ci.category === category && ci.key === key);
      if (existingIndex > -1) {
        cart[existingIndex] = cartItem;
      } else {
        cart.push(cartItem);
      }
      updateCartDisplay();
    }

    function removeCartItem(category, key) {
      const idx = cart.findIndex(ci => ci.category === category && ci.key === key);
      if (idx > -1) {
        cart.splice(idx, 1);
        updateCartDisplay();
      }
    }

    // Update cart display
   function updateCartDisplay() {
  const cartContainer = document.getElementById('cart-container');
  const cartTotal = document.getElementById('cart-total');
  const totalAmountEl = document.getElementById('total-amount');

  // Load per pax price from quantity selection
  const selectedWithQuantity = JSON.parse(localStorage.getItem('selectedItemWithQuantity') || 'null');
  let perPaxPrice = 0;
  if (selectedWithQuantity && selectedWithQuantity.price) {
    perPaxPrice = parseFloat(selectedWithQuantity.price);
  }

  // Get number of packs
  const packsInput = document.getElementById('packs-input');
  const paxCount = parseInt(packsInput.value) || 0;

  // Calculate total = per pax × packs
  const total = perPaxPrice * paxCount;

  // Collect all selected items (radio + checkboxes)
  let selectedItems = [];

  // Radios
  document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
    const category = radio.name;
    const optionId = radio.value;
    const option = menuData[category]?.[optionId];
    if (option) {
      selectedItems.push({
        name: option.name,
        image: option.image
      });
    }
  });

  // Checkboxes
  document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
    const category = checkbox.name;
    const optionId = checkbox.value;
    const option = menuData[category]?.[optionId];
    if (option) {
      selectedItems.push({
        name: option.name,
        image: option.image
      });
    }
  });

  // Build cart UI
  if (selectedItems.length > 0) {
    cartContainer.innerHTML = selectedItems.map(item => `
      <div class="bg-white p-3 rounded border border-gray-200 mb-2">
        <div class="flex items-center gap-3">
          <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded object-cover">
          <div class="flex-1">
            <div class="text-sm font-semibold text-gray-800">${item.name}</div>
          </div>
        </div>
      </div>
    `).join('');
  } else {
    cartContainer.innerHTML = `
      <div class="text-gray-500 text-sm text-center py-4">
        <i class="fas fa-shopping-cart text-xl mb-2"></i><br>
        No items selected yet.
      </div>
    `;
  }

  // Update total
  totalAmountEl.textContent = `$${total.toFixed(2)}`;
  cartTotal.style.display = 'block';
}


    // Remove from cart by list index (used in sidebar)
    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }

    // Next button
    document.getElementById('next-bottom').addEventListener('click', () => {
      // Validate exact item selection count
      const counts = countCurrentSelections();
      if (counts.total !== totalSelectableItems) {
        Swal.fire({ 
          icon: 'warning', 
          title: 'Incorrect selection', 
          text: `You must select exactly ${totalSelectableItems} items. Currently selected: ${counts.total}` 
        });
        return;
      }
      
      if (cart.length === 0) {
        Swal.fire({ icon: 'warning', title: 'No items', text: 'Please add at least one item to your cart.' });
        return;
      }
      
      // Validate delivery date and time
      const deliveryDate = document.getElementById('delivery-date').value;
      const deliveryTime = document.getElementById('delivery-time').value;
      
      if (!deliveryDate || !deliveryTime) {
        Swal.fire({ icon: 'error', title: 'Missing info', text: 'Please select delivery date and time.' });
        return;
      }
      
      // Calculate and store the total
      const selectedWithQuantity = JSON.parse(localStorage.getItem('selectedItemWithQuantity') || 'null');
      let perPaxPrice = 0;
      if (selectedWithQuantity && selectedWithQuantity.price) {
        perPaxPrice = parseFloat(selectedWithQuantity.price);
      }
      const packsInput = document.getElementById('packs-input');
      const paxCount = parseInt(packsInput.value) || 0;
      const calculatedTotal = perPaxPrice * paxCount;

      // Clear any previous non-customizable cart to avoid conflicts
      localStorage.removeItem('nonCustomizableCart');
      
      // Save cart and delivery info to localStorage
      localStorage.setItem('customizationCart', JSON.stringify(cart));
      localStorage.setItem('orderTotal', calculatedTotal.toString());
      localStorage.setItem('deliveryInfo', JSON.stringify({
        date: deliveryDate,
        time: deliveryTime,
        packs: packs
      }));
      
      // Navigate to next page
      localStorage.setItem('cart', JSON.stringify(cart));
      window.location.href = 'cart.html';
    });
  </script>

</body>
</html>
